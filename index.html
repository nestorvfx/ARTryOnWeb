<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Unity Web Player | ARTryOnUnity</title>
  </head>
  <body style="text-align: center; padding: 0; border: 0; margin: 0;">
    <canvas id="unity-canvas" width=700 height=700 tabindex="-1" style="width: 700px; height: 700px; background: #231F20"></canvas>
    <script src="Build/Web Build.loader.js"></script>
    <script>
      #!/usr/bin/env node
const path = require('path');
const express = require('express');

// Create express application
const app = express();

// Settings
const hostname = 'localhost';
const port = 8080;
const enableCORS = true; 
const enableWasmMultithreading = true;


// Serve the current working directory 
const unityBuildPath = __dirname; // Note: this makes the current working directory visible to all computers over the network.

app.use((req, res, next) => {
    var path = req.url;

    // Provide COOP, COEP and CORP headers for SharedArrayBuffer
    // multithreading: https://web.dev/coop-coep/
    if (enableWasmMultithreading &&
        (
            path == '/' ||
            path.includes('.js') ||
            path.includes('.html') ||
            path.includes('.htm')
        )
    ) {
        res.set('Cross-Origin-Opener-Policy', 'same-origin');
        res.set('Cross-Origin-Embedder-Policy', 'require-corp');
        res.set('Cross-Origin-Resource-Policy', 'cross-origin');
    }

    // Set CORS headers
    if (enableCORS) {
        res.set('Access-Control-Allow-Origin', '*');
    }    

    // Set content encoding depending on compression
    if (path.endsWith('.br')) {
        res.set('Content-Encoding', 'br');
    } else if (path.endsWith('.gz')) {
        res.set('Content-Encoding', 'gzip');
    }

    // Explicitly set content type. Files can have wrong content type if build uses compression.
    if (path.includes('.wasm')) {
        res.set('Content-Type', 'application/wasm');
    } else if (path.includes('.js')) {
        res.set('Content-Type', 'application/javascript');
    } else if (path.includes('.json')) {
        res.set('Content-Type', 'application/json');
    } else if (
    path.includes('.data') ||
    path.includes('.bundle') ||
    path.endsWith('.unityweb')
    ) {
        res.set('Content-Type', 'application/octet-stream');
    }

    // Ignore cache-control: no-cache 
    // when if-modified-since or if-none-match is set
    // because Unity Loader will cache and revalidate manually
    if (req.headers['cache-control'] == 'no-cache' &&
    (
        req.headers['if-modified-since'] ||
        req.headers['if-none-match']
    )
    ) {       
        delete req.headers['cache-control'];
    }        

    next();
});

app.use('/', express.static(unityBuildPath, { immutable: true }));

const server = app.listen(port, hostname, () => {
    console.log(`Web server serving directory ${unityBuildPath} at http://${hostname}:${port}`);
});

server.addListener('error', (error) => {
    console.error(error);
});

server.addListener('close', () => {
    console.log('Server stopped.');
    process.exit();
});

      if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
        // Mobile device style: fill the whole browser client area with the game canvas:
        var meta = document.createElement('meta');
        meta.name = 'viewport';
        meta.content = 'width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes';
        document.getElementsByTagName('head')[0].appendChild(meta);

        var canvas = document.querySelector("#unity-canvas");
        canvas.style.width = "100%";
        canvas.style.height = "100%";
        canvas.style.position = "fixed";

        document.body.style.textAlign = "left";
      }

      createUnityInstance(document.querySelector("#unity-canvas"), {
        arguments: [],
        dataUrl: "Build/Web Build.data.br",
        frameworkUrl: "Build/Web Build.framework.js.br",
        codeUrl: "Build/Web Build.wasm.br",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "DefaultCompany",
        productName: "ARTryOnUnity",
        productVersion: "0.1.0",
        // matchWebGLToCanvasSize: false, // Uncomment this to separately control WebGL canvas render size and DOM element size.
        // devicePixelRatio: 1, // Uncomment this to override low DPI rendering on high DPI displays.
      });
    </script>
  </body>
</html>
